<!---Coded and designed by Maris Vainre, Becky Gilbert, and Marc Bennet.
When using this work, or any part of it, please cite it:
Maris Vainre, Becky Gilbert & Marc Bennett. Affective Probabilistic Reversal Learning Task using jsPsych. Github repository.
https://github.com/mvainre/affective-probabilistic-reversal-learning-task--->

<!DOCTYPE html>
<html>
<head>
    <title>SWELL: The Fictional Football Cup</title>
    <script src = "js/jquery.min.js" type="text/javascript"></script>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugins/jspsych-instructions.js"></script>
    <script src="jspsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych/plugins/jspsych-vsl-grid-scene.js"></script>
    <script src="jspsych/plugins/jspsych-fullscreen.js"></script>
    <script src = "jatos.js"></script> /* uncomment all jatos-related lines to run outside jatos
    <link href="css/SwellStyle.css" rel="stylesheet" type="text/css"> /* this may need changing for the script to run
    <meta charset="utf-8">
    <style>
        /* here's the CSS if you want to change the padding around the images */
        td {
            padding: 0px 0px !important;
            border: 0px !important;
        }
    </style>
</head>
<body></body>

<script type="text/javascript">

    //task set-up:
    //Participant needs to choose a winning team between two competing football teams. There are 4 teams and 2 set pairs.
    //The side of the field is randomised (AB matches could be set up as A-B or B-A)
    //Each match is preceded by an image that can be either negative or neutral in nature
    //There are 3 phases in each condition. Conditions are counterbalanced.

    //set up timeline
    var timeline = [];

    // set up how many trials are run per phase, the actual matches will be double that.
    var numberOfTrials = 19; //19 here due to number of images available

    //set up durations
    var fixationDuration = 300;
    var IAPSduration = 1500;
    var stimulusDuration = 2000;
    var postTrial_gap = 500;
    var feedbackDuration = 1000;
    var errorDuration = 1500;

    //set up team logos
    var logo1 = 'img/Logos/1.png';
    var logo2 = 'img/Logos/2.png';
    var logo3 = 'img/Logos/3.png';
    var logo4 = 'img/Logos/4.png';

    // create an array of all pictures in the IAPS database
    var photoDatabase_neu_trial = ['img/IAPS/Neutral/2020.f.jpg',
                                    'img/IAPS/Neutral/2020.jpg',
                                    'img/IAPS/Neutral/2025.f.jpg',
                                    'img/IAPS/Neutral/2025.jpg',
                                    'img/IAPS/Neutral/2102.f.jpg',
                                    'img/IAPS/Neutral/2102.jpg',
                                    'img/IAPS/Neutral/2191.f.jpg',
                                    'img/IAPS/Neutral/2191.jpg',
                                    'img/IAPS/Neutral/2214.f.jpg',
                                    'img/IAPS/Neutral/2214.jpg',
                                    'img/IAPS/Neutral/2220.f.jpg',
                                    'img/IAPS/Neutral/2220.jpg',
                                    'img/IAPS/Neutral/2305.f.jpg',
                                    'img/IAPS/Neutral/2305.jpg',
                                    'img/IAPS/Neutral/2357.f.jpg',
                                    'img/IAPS/Neutral/2357.jpg',
                                    'img/IAPS/Neutral/2372.f.jpg',
                                    'img/IAPS/Neutral/2372.jpg',
                                    'img/IAPS/Neutral/2381.f.jpg',
                                    'img/IAPS/Neutral/2381.jpg',
                                    'img/IAPS/Neutral/2385.f.jpg',
                                    'img/IAPS/Neutral/2385.jpg',
                                    'img/IAPS/Neutral/2394.f.jpg',
                                    'img/IAPS/Neutral/2394.jpg',
                                    'img/IAPS/Neutral/2396.f.jpg',
                                    'img/IAPS/Neutral/2396.jpg',
                                    'img/IAPS/Neutral/2485.f.jpg',
                                    'img/IAPS/Neutral/2485.jpg',
                                    'img/IAPS/Neutral/2487.f.jpg',
                                    'img/IAPS/Neutral/2487.jpg',
                                    'img/IAPS/Neutral/2493.f.jpg',
                                    'img/IAPS/Neutral/2493.jpg',
                                    'img/IAPS/Neutral/2495.f.jpg',
                                    'img/IAPS/Neutral/2495.jpg',
                                    'img/IAPS/Neutral/2499.f.jpg',
                                    'img/IAPS/Neutral/2499.jpg',
                                    'img/IAPS/Neutral/2506.f.jpg',
                                    'img/IAPS/Neutral/2506.jpg',
                                    'img/IAPS/Neutral/2512.f.jpg',
                                    'img/IAPS/Neutral/2512.jpg',
                                    'img/IAPS/Neutral/2513.f.jpg',
                                    'img/IAPS/Neutral/2513.jpg',
                                    'img/IAPS/Neutral/2516.f.jpg',
                                    'img/IAPS/Neutral/2516.jpg',
                                    'img/IAPS/Neutral/2518.f.jpg',
                                    'img/IAPS/Neutral/2518.jpg',
                                    'img/IAPS/Neutral/2575.f.jpg',
                                    'img/IAPS/Neutral/2575.jpg',
                                    'img/IAPS/Neutral/2579.f.jpg',
                                    'img/IAPS/Neutral/2579.jpg',
                                    'img/IAPS/Neutral/2593.f.jpg',
                                    'img/IAPS/Neutral/2593.jpg',
                                    'img/IAPS/Neutral/2595.f.jpg',
                                    'img/IAPS/Neutral/2595.jpg',
                                    'img/IAPS/Neutral/2597.f.jpg',
                                    'img/IAPS/Neutral/2597.jpg',
                                    'img/IAPS/Neutral/2635.f.jpg',
                                    'img/IAPS/Neutral/2635.jpg',
                                    'img/IAPS/Neutral/2702.f.jpg',
                                    'img/IAPS/Neutral/2702.jpg',
                                    'img/IAPS/Neutral/2704.f.jpg',
                                    'img/IAPS/Neutral/2704.jpg',
                                    'img/IAPS/Neutral/2745.1.f.jpg',
                                    'img/IAPS/Neutral/2745.1.jpg',
                                    'img/IAPS/Neutral/2749.f.jpg',
                                    'img/IAPS/Neutral/2749.jpg',
                                    'img/IAPS/Neutral/2850.f.jpg',
                                    'img/IAPS/Neutral/2850.jpg',
                                    'img/IAPS/Neutral/2870.f.jpg',
                                    'img/IAPS/Neutral/2870.jpg',
                                    'img/IAPS/Neutral/3550.2.f.jpg',
                                    'img/IAPS/Neutral/3550.2.jpg',
                                    'img/IAPS/Neutral/4274.f.jpg',
                                    'img/IAPS/Neutral/4274.jpg',
                                    'img/IAPS/Neutral/4275.f.jpg',
                                    'img/IAPS/Neutral/4275.jpg',
                                    'img/IAPS/Neutral/4500.f.jpg',
                                    'img/IAPS/Neutral/4500.jpg',
                                    'img/IAPS/Neutral/4510.f.jpg',
                                    'img/IAPS/Neutral/4510.jpg',
                                    'img/IAPS/Neutral/4531.f.jpg',
                                    'img/IAPS/Neutral/4531.jpg',
                                    'img/IAPS/Neutral/4534.f.jpg',
                                    'img/IAPS/Neutral/4534.jpg',
                                    'img/IAPS/Neutral/4537.f.jpg',
                                    'img/IAPS/Neutral/4537.jpg',
                                    'img/IAPS/Neutral/4559.f.jpg',
                                    'img/IAPS/Neutral/4559.jpg',
                                    'img/IAPS/Neutral/4571.f.jpg',
                                    'img/IAPS/Neutral/4571.jpg',
                                    'img/IAPS/Neutral/4605.f.jpg',
                                    'img/IAPS/Neutral/4605.jpg',
                                    'img/IAPS/Neutral/6570.2.f.jpg',
                                    'img/IAPS/Neutral/6570.2.jpg',
                                    'img/IAPS/Neutral/7493.f.jpg',
                                    'img/IAPS/Neutral/7493.jpg',
                                    'img/IAPS/Neutral/7506.f.jpg',
                                    'img/IAPS/Neutral/7506.jpg',
                                    'img/IAPS/Neutral/7550.f.jpg',
                                    'img/IAPS/Neutral/7550.jpg',
                                    'img/IAPS/Neutral/8060.f.jpg',
                                    'img/IAPS/Neutral/8060.jpg',
                                    'img/IAPS/Neutral/8160.f.jpg',
                                    'img/IAPS/Neutral/8160.jpg',
                                    'img/IAPS/Neutral/8192.f.jpg',
                                    'img/IAPS/Neutral/8192.jpg',
                                    'img/IAPS/Neutral/8232.f.jpg',
                                    'img/IAPS/Neutral/8232.jpg',
                                    'img/IAPS/Neutral/8241.f.jpg',
                                    'img/IAPS/Neutral/8241.jpg',
                                    'img/IAPS/Neutral/8475.f.jpg',
                                    'img/IAPS/Neutral/8475.jpg',
                                    'img/IAPS/Neutral/9070.f.jpg',
                                    'img/IAPS/Neutral/9070.jpg',
                                    ];

    var photoDatabase_neg_trial = ['img/IAPS/Negative/2055.1.f.jpg',
                                  'img/IAPS/Negative/2055.1.jpg',
                                  'img/IAPS/Negative/2100.f.jpg',
                                  'img/IAPS/Negative/2100.jpg',
                                  'img/IAPS/Negative/2110.f.jpg',
                                  'img/IAPS/Negative/2110.jpg',
                                  'img/IAPS/Negative/2120.f.jpg',
                                  'img/IAPS/Negative/2120.jpg',
                                  'img/IAPS/Negative/2141.f.jpg',
                                  'img/IAPS/Negative/2141.jpg',
                                  'img/IAPS/Negative/2276.f.jpg',
                                  'img/IAPS/Negative/2276.jpg',
                                  'img/IAPS/Negative/2278.f.jpg',
                                  'img/IAPS/Negative/2278.jpg',
                                  'img/IAPS/Negative/2312.f.jpg',
                                  'img/IAPS/Negative/2312.jpg',
                                  'img/IAPS/Negative/2399.f.jpg',
                                  'img/IAPS/Negative/2399.jpg',
                                  'img/IAPS/Negative/2455.f.jpg',
                                  'img/IAPS/Negative/2455.jpg',
                                  'img/IAPS/Negative/2490.f.jpg',
                                  'img/IAPS/Negative/2490.jpg',
                                  'img/IAPS/Negative/2590.f.jpg',
                                  'img/IAPS/Negative/2590.jpg',
                                  'img/IAPS/Negative/2694.f.jpg',
                                  'img/IAPS/Negative/2694.jpg',
                                  'img/IAPS/Negative/2700.f.jpg',
                                  'img/IAPS/Negative/2700.jpg',
                                  'img/IAPS/Negative/2710.f.jpg',
                                  'img/IAPS/Negative/2710.jpg',
                                  'img/IAPS/Negative/2718.f.jpg',
                                  'img/IAPS/Negative/2718.jpg',
                                  'img/IAPS/Negative/2745.2.f.jpg',
                                  'img/IAPS/Negative/2745.2.jpg',
                                  'img/IAPS/Negative/2750.f.jpg',
                                  'img/IAPS/Negative/2750.jpg',
                                  'img/IAPS/Negative/2753.f.jpg',
                                  'img/IAPS/Negative/2753.jpg',
                                  'img/IAPS/Negative/2900.f.jpg',
                                  'img/IAPS/Negative/2900.jpg',
                                  'img/IAPS/Negative/3017.f.jpg',
                                  'img/IAPS/Negative/3017.jpg',
                                  'img/IAPS/Negative/3160.f.jpg',
                                  'img/IAPS/Negative/3160.jpg',
                                  'img/IAPS/Negative/3215.f.jpg',
                                  'img/IAPS/Negative/3215.jpg',
                                  'img/IAPS/Negative/3216.f.jpg',
                                  'img/IAPS/Negative/3216.jpg',
                                  'img/IAPS/Negative/3220.f.jpg',
                                  'img/IAPS/Negative/3220.jpg',
                                  'img/IAPS/Negative/3280.f.jpg',
                                  'img/IAPS/Negative/3280.jpg',
                                  'img/IAPS/Negative/3300.f.jpg',
                                  'img/IAPS/Negative/3300.jpg',
                                  'img/IAPS/Negative/4621.f.jpg',
                                  'img/IAPS/Negative/4621.jpg',
                                  'img/IAPS/Negative/6010.f.jpg',
                                  'img/IAPS/Negative/6010.jpg',
                                  'img/IAPS/Negative/6242.f.jpg',
                                  'img/IAPS/Negative/6242.jpg',
                                  'img/IAPS/Negative/6311.f.jpg',
                                  'img/IAPS/Negative/6311.jpg',
                                  'img/IAPS/Negative/6562.f.jpg',
                                  'img/IAPS/Negative/6562.jpg',
                                  'img/IAPS/Negative/6571.f.jpg',
                                  'img/IAPS/Negative/6571.jpg',
                                  'img/IAPS/Negative/6825.f.jpg',
                                  'img/IAPS/Negative/6825.jpg',
                                  'img/IAPS/Negative/6831.f.jpg',
                                  'img/IAPS/Negative/6831.jpg',
                                  'img/IAPS/Negative/6836.f.jpg',
                                  'img/IAPS/Negative/6836.jpg',
                                  'img/IAPS/Negative/8231.f.jpg',
                                  'img/IAPS/Negative/8231.jpg',
                                  'img/IAPS/Negative/9007.f.jpg',
                                  'img/IAPS/Negative/9007.jpg',
                                  'img/IAPS/Negative/9041.f.jpg',
                                  'img/IAPS/Negative/9041.jpg',
                                  'img/IAPS/Negative/9046.f.jpg',
                                  'img/IAPS/Negative/9046.jpg',
                                  'img/IAPS/Negative/9190.f.jpg',
                                  'img/IAPS/Negative/9190.jpg',
                                  'img/IAPS/Negative/9265.f.jpg',
                                  'img/IAPS/Negative/9265.jpg',
                                  'img/IAPS/Negative/9270.f.jpg',
                                  'img/IAPS/Negative/9270.jpg',
                                  'img/IAPS/Negative/9331.f.jpg',
                                  'img/IAPS/Negative/9331.jpg',
                                  'img/IAPS/Negative/9341.f.jpg',
                                  'img/IAPS/Negative/9341.jpg',
                                  'img/IAPS/Negative/9404.f.jpg',
                                  'img/IAPS/Negative/9404.jpg',
                                  'img/IAPS/Negative/9415.f.jpg',
                                  'img/IAPS/Negative/9415.jpg',
                                  'img/IAPS/Negative/9417.f.jpg',
                                  'img/IAPS/Negative/9417.jpg',
                                  'img/IAPS/Negative/9419.f.jpg',
                                  'img/IAPS/Negative/9419.jpg',
                                  'img/IAPS/Negative/9426.f.jpg',
                                  'img/IAPS/Negative/9426.jpg',
                                  'img/IAPS/Negative/9427.f.jpg',
                                  'img/IAPS/Negative/9427.jpg',
                                  'img/IAPS/Negative/9430.f.jpg',
                                  'img/IAPS/Negative/9430.jpg',
                                  'img/IAPS/Negative/9452.f.jpg',
                                  'img/IAPS/Negative/9452.jpg',
                                  'img/IAPS/Negative/9490.f.jpg',
                                  'img/IAPS/Negative/9490.jpg',
                                  'img/IAPS/Negative/9520.f.jpg',
                                  'img/IAPS/Negative/9520.jpg',
                                  'img/IAPS/Negative/9530.f.jpg',
                                  'img/IAPS/Negative/9530.jpg',
                                  'img/IAPS/Negative/9584.f.jpg',
                                  'img/IAPS/Negative/9584.jpg',
                                  'img/IAPS/Negative/9900.f.jpg',
                                  'img/IAPS/Negative/9900.jpg',
                                  'img/IAPS/Negative/9926.f.jpg',
                                  'img/IAPS/Negative/9926.jpg',
                                    ];

    var logo_size = 300; // pixelscc
    var image_size = 500;

    // make the experiment to be fullscreen to avoid distractions
    timeline.push({
      type: 'fullscreen',
      fullscreen_mode: true
    });

    // set up which keys to press for answering
    let choices = ["c", "n"];

    // create global variables to store information that you want to pass between trials/functions
    var phase1LoserAB = '';
    var phase1WinnerAB = '';
    var phase1LoserCD = '';
    var phase1WinnerCD = '';

    // set up trial counter
    let currentTrialNumber = 1;
    var Phase1_trialnumber = 1;
    var Phase2_trialnumber = 1;
    var Phase3_trialnumber = 1;
    var Phase4_trialnumber = 1;
    var Phase5_trialnumber = 1;
    var Phase6_trialnumber = 1;

    // collecting the trial info variables into this globally scoped object
    var trialInfo = {
        phase: 1,
        teamLeft: '',
        teamRight: '',
        IAPSconditionSelected: '',
        pointsTotal: 0
    };

    // assign team logos to teams randomly. This ensures that across participants, different "logos" play against each other.
    var logos = [logo1, logo2, logo3, logo4];
    var shuffleLogos = jsPsych.randomization.shuffle(logos);
    var teamA = shuffleLogos[0];
    var teamB = shuffleLogos[1];
    var teamC = shuffleLogos[2];
    var teamD = shuffleLogos[3];
    // just checking if all's running well:
    console.log("Team A is: " + teamA);
    console.log("Team B is: " + teamB);
    console.log("Team C is: " + teamC);
    console.log("Team D is: " + teamD);

    /* define welcome message*/
    var welcome = {
        type: "html-keyboard-response",
        stimulus: "<h1>The Fictional Football Match Game</h1>" +
            "<p>Thank you for taking your time to participate in this study! </p><h2>Press any key to start</h2>"
    };
    timeline.push(welcome);

    var instructions1 = {
        type: 'instructions',
        pages: ["<h1>Get settled in for the next 15 minutes</h1>" +
            "<p>Make sure you're <b>sitting comfortably</b>.<br><br><h1>&#x1F515</h1>Shield yourself from <b>distractions</b>: <br>&#x1F4F4 <b>mute</b> your phone and <br>&#x1F4E9 e-mail alerts </p>" +

            "<h2><br>Ready? Press space to continue</h2>"],
        key_forward: 32, // code for space
        show_clickable_nav: false
    };
    timeline.push(instructions1);

    var instructions3 = {
        type: 'instructions',
        pages: ["<h1>&#x26BD</h1><p>This game is about <b>guessing which fictional football team won</b> a hypothetical match.</p>"+

        "<p>The teams played in a mini-league. <br>The same two teams played against each other over an entire season.</p>" +

        "<h2><br>Press space to see the matches</h2>"],
        key_forward: 32, // code for space
        show_clickable_nav: false
    };
    timeline.push(instructions3);

    //Display the teams' logos in pairs in which they will appear
    var teamsAB = [
        [teamA, 0, teamB]
    ];

    var teamsAB_demo_prep = jsPsych.plugins['vsl-grid-scene'].generate_stimulus(teamsAB, [logo_size, logo_size]);

    var teamsAB_demo = {
        type: 'html-keyboard-response',
        stimulus: teamsAB_demo_prep,
        choices: [32],
        prompt: "<h2>Press space to see the next match</h2>",
        stimulus_duration: null,
        trial_duration: null,
        response_ends_trial: true //displayed until space is pressed
    };
    timeline.push(teamsAB_demo);

    var teamsCD = [
        [teamC, 0,  teamD]
    ];

    var teamsCD_demo_prep = jsPsych.plugins['vsl-grid-scene'].generate_stimulus(teamsCD, [logo_size, logo_size]);

    var teamsCD_demo = {
        type: 'html-keyboard-response',
        stimulus: teamsCD_demo_prep,
        choices: [32],
        prompt: "<p>That's it!</p><h2>Press space to continue</h2>",
        trial_duration: null,
        response_ends_trial: true
    };
    timeline.push(teamsCD_demo);

    var instructions4 = {
        type: 'instructions',
        pages: ["<h1>&#x1F3C6</h1>"+
          "<h2>Your job is simple: <br>guess which team won each match</h2>"+

            "<p>Select the team that you think was most likely to win that match. <br>Do this by pressing the right key: <br><b>C-key = team on the left.       N-key = team on the right.</b></p>" +

            "<h2><br>Press space to continue</h2>"],
        key_forward: 32, // code for space
        show_clickable_nav: false
    };
    timeline.push(instructions4);

    var instructions5 = {
        type: 'instructions',
        pages: [
            "<h1>&#x1F4B0</h1>" +
            "<p>Correct guesses will win you some (hypothetical) cash: <br><b>£0.10</b> to be precise. <br>If you guess wrong, don't worry - you won't lose any money.</p>" +
            "<p><b>Your goal is to earn as much fictional £££ as possible</b> by the end of the season.</p>" +

            "<h2><br>Press space to continue</h2>"],
        key_forward: 32, // code for space
        show_clickable_nav: false
    };
    timeline.push(instructions5);


    var instructions6 = {
        type: 'instructions',
        pages: [
            "<h1>&#x1F945</h1>" +
            "<p>At first, you might not be sure who was likely to win but <br><b>soon you might develop an idea about which team was stronger</b> at a given time in the season.<p>"+
            "<p><b>Stay focused:</b> <br>teams may have improved or deteriorated over time. <br>Use the feedback provided to guess the winner and win non-real £££.</p>" +

            "<h2><br>Press space to continue</h2>"],
        key_forward: 32, // code for space
        show_clickable_nav: false
    };
    timeline.push(instructions6);

    var instructions7 = {
        type: 'instructions',
        pages: [
            "<p>Also, before each match, you'll see a photo. It's there to keep you alert. <br>It won't predict the result of the match.</p>"+
            "<h2><br>Press space to continue</h2>"],
        key_forward: 32, // code for space
        show_clickable_nav: false
    };
    timeline.push(instructions7);


    var instructions8 = {
        type: 'instructions',
        pages: ["<h1>&#x23F1</h1>"+
            "<h2>Try to be <b>as quick as possible</b> in your responses</h2>"+
            "<p>To make it faster, <br>put your left index finger on the C-key and your right index finger on the N-key.</b></p>"+
            "<h2><br>Ready? Press space to start</h2>"],
        key_forward: 32, // code for space
        show_clickable_nav: false
    };
    timeline.push(instructions8);

    // Set up elements that are universal across the task

    // Gets triggered when response in the 5 last trials has been slower than 700ms.
    // It was initially 500ms but testing showed it was too quick and annoyed people.
    // Only kicks in after 6 trials have run.
      var too_slow_message = {
          type: 'html-keyboard-response',
          stimulus: '<h1 style="color:#ef476f;">Please respond faster</h1>',
          trial_duration: errorDuration
      };

      var display_too_slow_message_conditional = {
          timeline: [too_slow_message],
          conditional_function: function() {
            if (currentTrialNumber > 6) {
              var meanrt_last5trials = jsPsych.data.get().filter({trial_element: 'match'}).last(5).select('rt').mean(); // takes the last 5 trials where choice needs to be made (labeled as match trials)
              if (meanrt_last5trials > 700) { // gets triggered if RT has been more than 700ms
                display_too_slow_message = true;
                console.log('I am being too slow. RT so far: ' + meanrt_last5trials);
                return true;
              } else {
                display_too_slow_message = false;
                console.log('going fast enough!. RT so far: ' + meanrt_last5trials);
                return false;
              }
            } else {
            console.log('trial number not yet 5. Current one: ' + currentTrialNumber);
            return false;
            }
          }
      };

      // Gets triggered when no keyboard response has made for the last 3 trials where response is needed. The trial is paused and will continue when space is pressed.
      var instructions_break1 = {
          type: 'instructions',
          pages: ["<h1>Need a break?</h1>" +
              "<p>Have a good stretch if so.</p>" +
              "<h2><br>Press space when you're ready to continue</h2>"],
          key_forward: 32, // code for space
          show_clickable_nav: false
      };

      var display_haveabreak_message_conditional = {
          timeline: [instructions_break1],
          conditional_function: function() {
              if (currentTrialNumber > 2) {
              var trial_totalmisses = jsPsych.data.get().filter({trial_element: 'match', key_press: null}).count(); // this is just to test the function in console. It has no functionality for the function and can be deleted.
              var trial_last3matches = jsPsych.data.get().filter({trial_element: 'match'}).last(3); // count the last 3 trials that are matches (ie where keypress is needed):
              var trial_last3matches_misses = trial_last3matches.filter({key_press: null}).count(); // count the number of times where there were no keypress (a proxy that the participant may not be paying attention);
              console.log('trials misses ' + trial_totalmisses + ' out of ' + currentTrialNumber + ' trials. Number of trials missed in the last 3: ' + trial_last3matches_misses);
              if (trial_last3matches_misses  == 3) { // gets triggered if missed at least 3 trials
                display_haveabreak_message = true;
                console.log('Should I have a break? I have missed many trials: ' + trial_last3matches_misses);
                return true;
              } else {
                display_haveabreak_message = false;
                console.log('No need for a break! Only missed few trials: ' + trial_last3matches_misses);
                return false;
              }
              } else {
              console.log('trial number not yet 3. Current one: ' + currentTrialNumber);
              return false;
              }
            },
      };

    // first show fixation
    var fixation = {
        type: 'html-keyboard-response',
        stimulus: '<span style="font-size:60px;">+</span>',
        choices: jsPsych.NO_KEYS,
        trial_duration: fixationDuration
    }

    // choose which which affective condition comes first
    var IAPSconditions = ['neg', 'neu'];
    var shuffleIAPSconditions = jsPsych.randomization.shuffle(IAPSconditions);
    var IAPScondition1 = shuffleIAPSconditions[0];
    var IAPScondition2 = shuffleIAPSconditions[1];

    // shuffle IAPS images so that the order is different for each participant
    var shuffleIAPSneg = jsPsych.randomization.shuffle(photoDatabase_neg_trial)
    var shuffleIAPSneu = jsPsych.randomization.shuffle(photoDatabase_neu_trial)

    function choose_IAPSimage() {
      console.log('condition: ', IAPScondition1);
      if (IAPScondition1 == 'neg') {
        IAPSimage = shuffleIAPSneg[currentTrialNumber-1]; // -1 because javascript starts indexing with 0
      } else {
        IAPSimage = shuffleIAPSneu[currentTrialNumber-1]; // -1 because javascript starts indexing with 0
      };
      console.log('image selected: ', IAPSimage);
      return [[IAPSimage]];
    }

    // now show an image, either negative or neutral as selected above
    var pick_IAPSimage = {
      type: 'html-keyboard-response',
      stimulus: function() {
        // need to wrap all of this in a function so that it runs on every repetition of the trial
        var curr_image = choose_IAPSimage();
        return jsPsych.plugins['vsl-grid-scene'].generate_stimulus(curr_image, [image_size]);
      },
      choices: jsPsych.NO_KEYS,
      prompt: "",
      trial_duration: IAPSduration,
      data: function () {
        return {
          trial_element: "iaps image",
          image_shown: IAPSimage,
          affect: IAPScondition1
        };
      },
    };

    // pick the winner for the first phase at random
    var ABmatches = [teamA, teamB];
    var shuffleABmatches = jsPsych.randomization.shuffle(ABmatches);
    var phase1WinnerAB = shuffleABmatches[1];
    var phase1LoserAB = shuffleABmatches[0];
    console.log('phase 1 winner AB: ', phase1WinnerAB);
    console.log('phase 1 loser AB: ', phase1LoserAB);

    var CDmatches = [teamC, teamD];
    var shuffleCDmatches = jsPsych.randomization.shuffle(CDmatches);
    var phase1WinnerCD = shuffleCDmatches[1];
    var phase1LoserCD = shuffleCDmatches[0];
    console.log('phase 1 winner CD: ', phase1WinnerCD);
    console.log('phase 1 loser CD: ', phase1LoserCD);

    //////// PHASE 1 ///////
    //set up trial Phase1 1. numberOfTrials controls how many times this thing loops.
    // participant will be shown a fixation cross, then a IAPS image that is either neutral or negative, and then the match

    function chooseLayout_subsequent_Phase1 (matchType) {
        console.log('match type: ', matchType);
        if (matchType == 'ab') {
            // create an array of all teams
            var teams = [teamA, teamB];
            // pick layout at random so all are equally likely.
            //That is, pick the team that is on the left. The other one is then on the right.
            var layoutSelected = jsPsych.randomization.sampleWithReplacement(teams, 1, [1, 1])[0];
            if (layoutSelected == teamA) {
                trialInfo_teamLeft = teamA;
                trialInfo_teamRight = teamB;
            } else {
                trialInfo_teamLeft = teamB;
                trialInfo_teamRight = teamA
            }
            return [[trialInfo_teamLeft, 0, trialInfo_teamRight]]; //this set-up is so it'd match with the format the jsPsych plugin needs to display the images
        } else {
            // create an array of teams
            var teams = [teamC, teamD];
            // pick layout at random so all are equally likely. Pick the team that will be on the left.
            var layoutSelected = jsPsych.randomization.sampleWithReplacement(teams, 1, [1, 1])[0];
            if (layoutSelected == teamC) {
                trialInfo_teamLeft = teamC; // adding trialInfo_Phase1 so that this can be accessed outside the function
                trialInfo_teamRight = teamD;
            } else {
                trialInfo_teamLeft = teamD;
                trialInfo_teamRight = teamC
            };
            return [[trialInfo_teamLeft, 0, trialInfo_teamRight]];
        }
    }

    // set up A-B trial for use in phase 1 looping trial procedure
    var match_phase1_subsequentAB = {
        type: 'html-keyboard-response',
        stimulus: function() {
            // need to wrap all of this in a function so that it runs on every repetition of the trial
            var curr_layout = chooseLayout_subsequent_Phase1('ab');
            var vsl_layout = jsPsych.plugins['vsl-grid-scene'].generate_stimulus(curr_layout, [logo_size, logo_size]);
            return vsl_layout;
        },
        choices: choices,
        prompt: "Who will win? Press C or N",
        trial_duration: stimulusDuration,
        data: function() {
            return {
                phase: 1,
                trial_element: "match",
                condition: IAPScondition1,
                PhaseTrialNumber: Phase1_trialnumber,
                teamLeft: trialInfo_teamLeft,
                teamRight: trialInfo_teamRight,
                phase1Winner: phase1WinnerAB,
                points_cumulative_excludingThisTrial: jsPsych.data.get().select('pointsTotal').max()
            };
        },
        on_finish: function(data) {
            Phase1_trialnumber += 1;
            currentTrialNumber += 1;
            // choose the winner
            var matchPlayers = [phase1WinnerAB, phase1LoserAB];
            var matchOutcome = jsPsych.randomization.sampleWithReplacement(matchPlayers, 1, [80, 20])[0];
            console.log('trial winner: ', matchOutcome);
            // add match winner to data
            data.match_winner = matchOutcome;

            var selected_team;
            if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c") {
                // if c key was pressed, then the participant chose whichever team was on the left
                selected_team = trialInfo_teamLeft;
            } else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n") {
                // if c key was pressed, then the participant chose whichever team was on the right
                selected_team = trialInfo_teamRight;
            }
            console.log('selected team: ', selected_team);
            // add selected team to data
            data.selected_team = selected_team;

            // compare the winning team with the selected team
            if (selected_team == matchOutcome) {
                console.log('correct selection');
                data.accuracy = true;
                trialInfo.pointsTotal = trialInfo.pointsTotal + 0.10;
                data.pointsTotal = trialInfo.pointsTotal;
                console.log('points: ' + trialInfo.pointsTotal);
            } else {
                console.log('incorrect selection');
                data.accuracy = false;
                trialInfo.pointsTotal = trialInfo.pointsTotal + 0;
                data.pointsTotal = trialInfo.pointsTotal;
                console.log('points: ' + trialInfo.pointsTotal);
            }
        }
    };

    // set up C-D trial for use in phase 1 looping trial procedure
    var match_phase1_subsequentCD = {
        type: 'html-keyboard-response',
        stimulus: function() {
            // need to wrap all of this in a function so that it runs on every repetition of the trial
            var curr_layout = chooseLayout_subsequent_Phase1('cd');
            var vsl_layout = jsPsych.plugins['vsl-grid-scene'].generate_stimulus(curr_layout, [logo_size, logo_size]);
            return vsl_layout;
        },
        choices: choices,
        prompt: "Who will win? Press C or N",
        trial_duration: stimulusDuration,
        data: function() {
            return {
                phase: 1,
                trial_element: "match",
                condition: IAPScondition1,
                trialNumber: Phase1_trialnumber,
                teamLeft: trialInfo_teamLeft,
                teamRight: trialInfo_teamRight,
                phase1Winner: phase1WinnerCD,
                points_cumulative_excludingThisTrial: jsPsych.data.get().select('pointsTotal').max()
            };
        },
        on_finish: function(data) {
            Phase1_trialnumber += 1;
            currentTrialNumber += 1;
            // choose the winner
            var matchPlayers = [phase1WinnerCD, phase1LoserCD];
            var matchOutcome = jsPsych.randomization.sampleWithReplacement(matchPlayers, 1, [80, 20])[0];
            console.log('trial winner: ', matchOutcome);
            // add match winner to data
            data.match_winner = matchOutcome;

            var selected_team;
            if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c") {
                // if c key was pressed, then the participant chose whichever team was on the left
                selected_team = trialInfo_teamLeft;
            } else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n") {
                // if n key was pressed, then the participant chose whichever team was on the right
                selected_team = trialInfo_teamRight;
            }
            console.log('selected team: ', selected_team);
            // add selected team to data
            data.selected_team = selected_team;

            // compare the winning team with the selected team
            // phase 1 winner/loser is just used to set the sampling weights so that the winner is selected more often)
            if (selected_team == matchOutcome) {
                console.log('correct selection');
                data.accuracy = true;
                trialInfo.pointsTotal = trialInfo.pointsTotal  + 0.10;
                console.log('points: ' + trialInfo.pointsTotal);
            } else {
                console.log('incorrect selection');
                data.accuracy = false;
                trialInfo.pointsTotal  = trialInfo.pointsTotal  + 0;
                console.log('points: ' + trialInfo.pointsTotal);
            }
        }
    };

    // set up points feedback screen for use in phase 1 looping trial procedure
    var points_tracker_inloop = {
        type: 'html-keyboard-response',
        stimulus: function () {
            var points_feedback = '<span style="color:#584b53;font-size:20px;">£0.00</span>';
            var last_match_correct = jsPsych.data.getLastTrialData().values()[0].accuracy;
            if (last_match_correct == true) {
                points_feedback = '<span style="color:#06d6a0;font-size:20px;">+£0.10</span>'
            }
            return points_feedback;
        },
        trial_duration: feedbackDuration
    };

    var trial_procedure_phase1_loop = {
        timeline: [fixation, pick_IAPSimage, match_phase1_subsequentAB, points_tracker_inloop, display_too_slow_message_conditional, display_haveabreak_message_conditional, fixation, pick_IAPSimage, match_phase1_subsequentCD, points_tracker_inloop],
        repetitions: numberOfTrials,
    };
    // add phase 1 looping procedure to the main timeline
    timeline.push(trial_procedure_phase1_loop);



    //////// PHASE 2 ////////
    //The probability will now be reversed but the condition stays same
    function chooseLayout_subsequent_Phase2 (matchType) {
        console.log('match type: ', matchType);
        if (matchType == 'ab') {
            // create an array of all teams
            var teams = [teamA, teamB];
            // pick layout at random so all are equally likely. That is, pick the team that is on the left.
            var layoutSelected = jsPsych.randomization.sampleWithReplacement(teams, 1, [1, 1])[0];
            if (layoutSelected == teamA) {
                trialInfo_teamLeft = teamA;
                trialInfo_teamRight = teamB;
            } else {
                trialInfo_teamLeft = teamB;
                trialInfo_teamRight = teamA
            }
            return [[trialInfo_teamLeft, 0, trialInfo_teamRight]];
        } else {
            // create an array of teams
            var teams = [teamC, teamD];
            // pick layout at random so all are equally likely. Pick the team that will be on the left.
            var layoutSelected = jsPsych.randomization.sampleWithReplacement(teams, 1, [1, 1])[0];
            if (layoutSelected == teamC) {
                trialInfo_teamLeft = teamC; // adding trialInfo_Phase1 so that this can be accessed outside the function
                trialInfo_teamRight = teamD;
            } else {
                trialInfo_teamLeft = teamD;
                trialInfo_teamRight = teamC
            };
            return [[trialInfo_teamLeft, 0, trialInfo_teamRight]];
        }
    }

    // set up A-B trial for use in phase 1 looping trial procedure
    var match_phase2_subsequentAB = {
        type: 'html-keyboard-response',
        stimulus: function() {
            // need to wrap all of this in a function so that it runs on every repetition of the trial
            var curr_layout = chooseLayout_subsequent_Phase2('ab');
            var vsl_layout = jsPsych.plugins['vsl-grid-scene'].generate_stimulus(curr_layout, [logo_size, logo_size]);
            return vsl_layout;
        },
        choices: choices,
        prompt: "Who will win? Press C or N",
        trial_duration: stimulusDuration,
        data: function() {
            return {
                phase: 2,
                trial_element: "match",
                condition: IAPScondition1,
                trialNumber: Phase2_trialnumber,
                teamLeft: trialInfo_teamLeft,
                teamRight: trialInfo_teamRight,
                phase2Winner: phase1LoserAB,
                points_cumulative_excludingThisTrial: jsPsych.data.get().select('pointsTotal').max()
            };
        },
        on_finish: function(data) {
            Phase2_trialnumber += 1;
            currentTrialNumber += 1;
            // choose the winner
            var matchPlayers = [phase1WinnerAB, phase1LoserAB];
            var matchOutcome = jsPsych.randomization.sampleWithReplacement(matchPlayers, 1, [20, 80])[0];
            console.log('trial winner: ', matchOutcome);
            // add match winner to data
            data.match_winner = matchOutcome;

            var selected_team;
            if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c") {
                // if c key was pressed, then the participant chose whichever team was on the left
                selected_team = trialInfo_teamLeft;
            } else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n") {
                // if c key was pressed, then the participant chose whichever team was on the right
                selected_team = trialInfo_teamRight;
            }
            console.log('selected team: ', selected_team);
            // add selected team to data
            data.selected_team = selected_team;

            // compare the winning team with the selected team
            if (selected_team == matchOutcome) {
                console.log('correct selection');
                data.accuracy = true;
                trialInfo.pointsTotal = trialInfo.pointsTotal + 0.10;
                data.pointsTotal = trialInfo.pointsTotal;
                console.log('points: ' + trialInfo.pointsTotal);
            } else {
                console.log('incorrect selection');
                data.accuracy = false;
                trialInfo.pointsTotal = trialInfo.pointsTotal + 0;
                data.pointsTotal = trialInfo.pointsTotal;
                console.log('points: ' + trialInfo.pointsTotal);
            }
        }
    };

    // set up C-D trial for use in phase 1 looping trial procedure
    var match_phase2_subsequentCD = {
        type: 'html-keyboard-response',
        stimulus: function() {
            // need to wrap all of this in a function so that it runs on every repetition of the trial
            var curr_layout = chooseLayout_subsequent_Phase2('cd');
            var vsl_layout = jsPsych.plugins['vsl-grid-scene'].generate_stimulus(curr_layout, [logo_size, logo_size]);
            return vsl_layout;
        },
        choices: choices,
        prompt: "Who will win? Press C or N",
        trial_duration: stimulusDuration,
        data: function() {
            return {
                phase: 2,
                trial_element: "match",
                condition: IAPScondition1,
                trialNumber: Phase2_trialnumber,
                teamLeft: trialInfo_teamLeft,
                teamRight: trialInfo_teamRight,
                phase2Winner: phase1LoserCD,
                points_cumulative_excludingThisTrial: jsPsych.data.get().select('pointsTotal').max()
            };
        },
        on_finish: function (data) {
            Phase2_trialnumber += 1;
            currentTrialNumber += 1;
            // choose the winner
            var matchPlayers = [phase1WinnerCD, phase1LoserCD];
            var matchOutcome = jsPsych.randomization.sampleWithReplacement(matchPlayers, 1, [20, 80])[0];
            console.log('trial winner: ', matchOutcome);
            // add match winner to data
            data.match_winner = matchOutcome;

            var selected_team;
            if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c") {
                // if c key was pressed, then the participant chose whichever team was on the left
                selected_team = trialInfo_teamLeft;
            } else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n") {
                // if n key was pressed, then the participant chose whichever team was on the right
                selected_team = trialInfo_teamRight;
            }
            console.log('selected team: ', selected_team);
            // add selected team to data
            data.selected_team = selected_team;

            // compare the winning team with the selected team
            // phase 1 winner/loser is just used to set the sampling weights so that the winner is selected more often)
            if (selected_team == matchOutcome) {
                console.log('correct selection');
                data.accuracy = true;
                trialInfo.pointsTotal = trialInfo.pointsTotal  + 0.10;
                console.log('points: ' + trialInfo.pointsTotal);
            } else {
                console.log('incorrect selection');
                data.accuracy = false;
                trialInfo.pointsTotal  = trialInfo.pointsTotal  + 0;
                console.log('points: ' + trialInfo.pointsTotal);
            }
        }
    };

    var trial_procedure_phase2_loop = {
        timeline: [fixation, pick_IAPSimage, match_phase2_subsequentAB, points_tracker_inloop, display_too_slow_message_conditional, display_haveabreak_message_conditional, fixation, pick_IAPSimage, match_phase2_subsequentCD, points_tracker_inloop],
        repetitions: numberOfTrials,
    };
    // add phase 2 looping procedure to the main timeline
    timeline.push(trial_procedure_phase2_loop);



    //////// PHASE 3 ////////
    function chooseLayout_subsequent_Phase3 (matchType) {
        console.log('match type: ', matchType);
        if (matchType == 'ab') {
            // create an array of all teams
            var teams = [teamA, teamB];
            // pick layout at random so all are equally likely. That is, pick the team that is on the left.
            var layoutSelected = jsPsych.randomization.sampleWithReplacement(teams, 1, [1, 1])[0];
            if (layoutSelected == teamA) {
                trialInfo_teamLeft = teamA;
                trialInfo_teamRight = teamB;
            } else {
                trialInfo_teamLeft = teamB;
                trialInfo_teamRight = teamA
            }
            return [[trialInfo_teamLeft, 0, trialInfo_teamRight]];
        } else {
            // create an array of teams
            var teams = [teamC, teamD];
            // pick layout at random so all are equally likely. Pick the team that will be on the left.
            var layoutSelected = jsPsych.randomization.sampleWithReplacement(teams, 1, [1, 1])[0];
            if (layoutSelected == teamC) {
                trialInfo_teamLeft = teamC; // adding trialInfo_Phase1 so that this can be accessed outside the function
                trialInfo_teamRight = teamD;
            } else {
                trialInfo_teamLeft = teamD;
                trialInfo_teamRight = teamC
            };
            return [[trialInfo_teamLeft, 0, trialInfo_teamRight]];
        }
    }

    // set up A-B trial for use in phase 3 looping trial procedure
    var match_phase3_subsequentAB = {
        type: 'html-keyboard-response',
        stimulus: function() {
            // need to wrap all of this in a function so that it runs on every repetition of the trial
            var curr_layout = chooseLayout_subsequent_Phase3('ab');
            var vsl_layout = jsPsych.plugins['vsl-grid-scene'].generate_stimulus(curr_layout, [logo_size, logo_size]);
            return vsl_layout;
        },
        choices: choices,
        prompt: "Who will win? Press C or N",
        trial_duration: stimulusDuration,
        data: function() {
            return {
                phase: 3,
                trial_element: "match",
                condition: IAPScondition1,
                trialNumber: Phase3_trialnumber,
                teamLeft: trialInfo_teamLeft,
                teamRight: trialInfo_teamRight,
                phase3Winner: phase1WinnerAB,
                points_cumulative_excludingThisTrial: jsPsych.data.get().select('pointsTotal').max()
            };
        },
        on_finish: function(data) {
            Phase3_trialnumber += 1;
            currentTrialNumber += 1;
            // choose the winner
            var matchPlayers = [phase1WinnerAB, phase1LoserAB];
            var matchOutcome = jsPsych.randomization.sampleWithReplacement(matchPlayers, 1, [80, 20])[0];
            console.log('trial winner: ', matchOutcome);
            // add match winner to data
            data.match_winner = matchOutcome;

            var selected_team;
            if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c") {
                // if c key was pressed, then the participant chose whichever team was on the left
                selected_team = trialInfo_teamLeft;
            } else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n") {
                // if c key was pressed, then the participant chose whichever team was on the right
                selected_team = trialInfo_teamRight;
            }
            console.log('selected team: ', selected_team);
            // add selected team to data
            data.selected_team = selected_team;

            // compare the winning team with the selected team
            if (selected_team == matchOutcome) {
                console.log('correct selection');
                data.accuracy = true;
                trialInfo.pointsTotal = trialInfo.pointsTotal + 0.10;
                data.pointsTotal = trialInfo.pointsTotal;
                console.log('points: ' + trialInfo.pointsTotal);
            } else {
                console.log('incorrect selection');
                data.accuracy = false;
                trialInfo.pointsTotal = trialInfo.pointsTotal + 0;
                data.pointsTotal = trialInfo.pointsTotal;
                console.log('points: ' + trialInfo.pointsTotal);
            }
        }
    };

    // set up C-D trial for use in phase 3 looping trial procedure
    var match_phase3_subsequentCD = {
        type: 'html-keyboard-response',
        stimulus: function() {
            // need to wrap all of this in a function so that it runs on every repetition of the trial
            var curr_layout = chooseLayout_subsequent_Phase3('cd');
            var vsl_layout = jsPsych.plugins['vsl-grid-scene'].generate_stimulus(curr_layout, [logo_size, logo_size]);
            return vsl_layout;
        },
        choices: choices,
        prompt: "Who will win? Press C or N",
        trial_duration: stimulusDuration,
        data: function() {
            return {
                phase: 3,
                trial_element: "match",
                condition: IAPScondition1,
                trialNumber: Phase3_trialnumber,
                teamLeft: trialInfo_teamLeft,
                teamRight: trialInfo_teamRight,
                phase3Winner: phase1WinnerCD,
                points_cumulative_excludingThisTrial: jsPsych.data.get().select('pointsTotal').max()
            };
        },
        on_finish: function(data) {
            Phase3_trialnumber += 1;
            currentTrialNumber += 1;
            // choose the winner
            var matchPlayers = [phase1WinnerCD, phase1LoserCD];
            var matchOutcome = jsPsych.randomization.sampleWithReplacement(matchPlayers, 1, [80, 20])[0];
            console.log('trial winner: ', matchOutcome);
            // add match winner to data
            data.match_winner = matchOutcome;

            var selected_team;
            if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c") {
                // if c key was pressed, then the participant chose whichever team was on the left
                selected_team = trialInfo_teamLeft;
            } else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n") {
                // if n key was pressed, then the participant chose whichever team was on the right
                selected_team = trialInfo_teamRight;
            }
            console.log('selected team: ', selected_team);
            // add selected team to data
            data.selected_team = selected_team;

            // compare the winning team with the selected team
            // phase 1 winner/loser is just used to set the sampling weights so that the winner is selected more often)
            if (selected_team == matchOutcome) {
                console.log('correct selection');
                data.accuracy = true;
                trialInfo.pointsTotal = trialInfo.pointsTotal  + 0.10;
                console.log('points: ' + trialInfo.pointsTotal);
            } else {
                console.log('incorrect selection');
                data.accuracy = false;
                trialInfo.pointsTotal  = trialInfo.pointsTotal  + 0;
                console.log('points: ' + trialInfo.pointsTotal);
            }
        }
    };

    var trial_procedure_phase3_loop = {
        timeline: [fixation, pick_IAPSimage, match_phase3_subsequentAB, points_tracker_inloop, display_too_slow_message_conditional, display_haveabreak_message_conditional, fixation, pick_IAPSimage, match_phase3_subsequentCD, points_tracker_inloop],
        repetitions: numberOfTrials,
    };
    // add phase 3 looping procedure to the main timeline
    timeline.push(trial_procedure_phase3_loop);


    ////////// CHANGE IN CONDITION //////////


    // asking if participant would like to have a break
    timeline.push(instructions_break1);


    // pick the winner for the fourth phase at random
    var shuffleABmatches = jsPsych.randomization.shuffle(ABmatches);
    var phase4WinnerAB = shuffleABmatches[1];
    var phase4LoserAB = shuffleABmatches[0];
    console.log('phase 4 winner AB: ', phase4WinnerAB);
    console.log('phase 4 loser AB: ', phase4LoserAB);

    var shuffleCDmatches = jsPsych.randomization.shuffle(CDmatches);
    var phase4WinnerCD = shuffleCDmatches[1];
    var phase4LoserCD = shuffleCDmatches[0];
    console.log('phase 4 winner CD: ', phase4WinnerCD);
    console.log('phase 4 loser CD: ', phase4LoserCD);



    //////// PHASE 4 ////////
    function choose_IAPSimage2() {
      console.log('starting condition: ', IAPScondition2);
      if (IAPScondition2 == 'neg') {
        IAPSimage = IAPSimage = shuffleIAPSneg[currentTrialNumber-114-1]; //There are 118 negative images and the previous part had 19*2*3=114 trials, so I'm resetting the counter that picks images from the random array that was created at the start of the trial
      } else {
        IAPSimage = IAPSimage = shuffleIAPSneu[currentTrialNumber-114-1]; //There are 114 neutral images and the previous part had 19*2*3=114 trials, so I'm resetting the counter that picks images from the random array that was created at the start of the trial
      };
      console.log('image selected: ', IAPSimage);
      return [[IAPSimage]];
    }

    var pick_IAPSimage2 = {
      type: 'html-keyboard-response',
      stimulus: function() {
        // need to wrap all of this in a function so that it runs on every repetition of the trial
        var curr_image = choose_IAPSimage2();
        return jsPsych.plugins['vsl-grid-scene'].generate_stimulus(curr_image, [image_size]);
      },
      choices: jsPsych.NO_KEYS,
      prompt: "",
      trial_duration: IAPSduration,
      data: function () {
        return {
          trial_element: "iaps image",
          image_shown: IAPSimage,
          affect: IAPScondition2
        };
      },
    };

    //set up trial Phase4. numberOfTrials controls how many times this thing loops.
    // participant will be shown a fixation cross, then a IAPS image that is either neutral or negative, and then the match

    function chooseLayout_subsequent_Phase4 (matchType) {
        console.log('match type: ', matchType);
        if (matchType == 'ab') {
            // create an array of all teams
            var teams = [teamA, teamB];
            // pick layout at random so all are equally likely. That is, pick the team that is on the left.
            var layoutSelected = jsPsych.randomization.sampleWithReplacement(teams, 1, [1, 1])[0];
            if (layoutSelected == teamA) {
                trialInfo_teamLeft = teamA;
                trialInfo_teamRight = teamB;
            } else {
                trialInfo_teamLeft = teamB;
                trialInfo_teamRight = teamA
            }
            return [[trialInfo_teamLeft, 0, trialInfo_teamRight]];
        } else {
            // create an array of teams
            var teams = [teamC, teamD];
            // pick layout at random so all are equally likely. Pick the team that will be on the left.
            var layoutSelected = jsPsych.randomization.sampleWithReplacement(teams, 1, [1, 1])[0];
            if (layoutSelected == teamC) {
                trialInfo_teamLeft = teamC; // adding trialInfo_Phase1 so that this can be accessed outside the function
                trialInfo_teamRight = teamD;
            } else {
                trialInfo_teamLeft = teamD;
                trialInfo_teamRight = teamC
            };
            return [[trialInfo_teamLeft, 0, trialInfo_teamRight]];
        }
    }

    // set up A-B trial for use in phase 4 looping trial procedure
    var match_phase4_subsequentAB = {
        type: 'html-keyboard-response',
        stimulus: function() {
            // need to wrap all of this in a function so that it runs on every repetition of the trial
            var curr_layout = chooseLayout_subsequent_Phase4('ab');
            var vsl_layout = jsPsych.plugins['vsl-grid-scene'].generate_stimulus(curr_layout, [logo_size, logo_size]);
            return vsl_layout;
        },
        choices: choices,
        prompt: "Who will win? Press C or N",
        trial_duration: stimulusDuration,
        data: function() {
            return {
                phase: 4,
                trial_element: "match",
                condition: IAPScondition2,
                trialNumber: Phase4_trialnumber,
                teamLeft: trialInfo_teamLeft,
                teamRight: trialInfo_teamRight,
                phase4Winner: phase4WinnerAB,
                points_cumulative_excludingThisTrial: jsPsych.data.get().select('pointsTotal').max()
            };
        },
        on_finish: function(data) {
            Phase4_trialnumber += 1;
            currentTrialNumber += 1;
            // choose the winner
            var matchPlayers = [phase4WinnerAB, phase4LoserAB];
            var matchOutcome = jsPsych.randomization.sampleWithReplacement(matchPlayers, 1, [80, 20])[0];
            console.log('trial winner: ', matchOutcome);
            // add match winner to data
            data.match_winner = matchOutcome;

            var selected_team;
            if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c") {
                // if c key was pressed, then the participant chose whichever team was on the left
                selected_team = trialInfo_teamLeft;
            } else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n") {
                // if c key was pressed, then the participant chose whichever team was on the right
                selected_team = trialInfo_teamRight;
            }
            console.log('selected team: ', selected_team);
            // add selected team to data
            data.selected_team = selected_team;

            // compare the winning team with the selected team
            if (selected_team == matchOutcome) {
                console.log('correct selection');
                data.accuracy = true;
                trialInfo.pointsTotal = trialInfo.pointsTotal + 0.10;
                data.pointsTotal = trialInfo.pointsTotal;
                console.log('points: ' + trialInfo.pointsTotal);
            } else {
                console.log('incorrect selection');
                data.accuracy = false;
                trialInfo.pointsTotal = trialInfo.pointsTotal + 0;
                data.pointsTotal = trialInfo.pointsTotal;
                console.log('points: ' + trialInfo.pointsTotal);
            }
        }
    };

    // set up C-D trial for use in phase 1 looping trial procedure
    var match_phase4_subsequentCD = {
        type: 'html-keyboard-response',
        stimulus: function() {
            // need to wrap all of this in a function so that it runs on every repetition of the trial
            var curr_layout = chooseLayout_subsequent_Phase4('cd');
            var vsl_layout = jsPsych.plugins['vsl-grid-scene'].generate_stimulus(curr_layout, [logo_size, logo_size]);
            return vsl_layout;
        },
        choices: choices,
        prompt: "Who will win? Press C or N",
        trial_duration: stimulusDuration,
        data: function() {
            return {
                phase: 4,
                trial_element: "match",
                condition: IAPScondition2,
                trialNumber: Phase4_trialnumber,
                teamLeft: trialInfo_teamLeft,
                teamRight: trialInfo_teamRight,
                phase4Winner: phase4WinnerCD,
                points_cumulative_excludingThisTrial: jsPsych.data.get().select('pointsTotal').max()
            };
        },
        on_finish: function(data) {
            Phase4_trialnumber += 1;
            currentTrialNumber += 1;
            // choose the winner
            var matchPlayers = [phase4WinnerCD, phase4LoserCD];
            var matchOutcome = jsPsych.randomization.sampleWithReplacement(matchPlayers, 1, [80, 20])[0];
            console.log('trial winner: ', matchOutcome);
            // add match winner to data
            data.match_winner = matchOutcome;

            var selected_team;
            if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c") {
                // if c key was pressed, then the participant chose whichever team was on the left
                selected_team = trialInfo_teamLeft;
            } else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n") {
                // if n key was pressed, then the participant chose whichever team was on the right
                selected_team = trialInfo_teamRight;
            }
            console.log('selected team: ', selected_team);
            // add selected team to data
            data.selected_team = selected_team;

            // compare the winning team with the selected team
            // phase 1 winner/loser is just used to set the sampling weights so that the winner is selected more often)
            if (selected_team == matchOutcome) {
                console.log('correct selection');
                data.accuracy = true;
                trialInfo.pointsTotal = trialInfo.pointsTotal  + 0.10;
                console.log('points: ' + trialInfo.pointsTotal);
            } else {
                console.log('incorrect selection');
                data.accuracy = false;
                trialInfo.pointsTotal  = trialInfo.pointsTotal  + 0;
                console.log('points: ' + trialInfo.pointsTotal);
            }
        }
    };

    var trial_procedure_phase4_loop = {
        timeline: [fixation, pick_IAPSimage2, match_phase4_subsequentAB, points_tracker_inloop, display_too_slow_message_conditional, display_haveabreak_message_conditional, fixation, pick_IAPSimage2, match_phase4_subsequentCD, points_tracker_inloop],
        repetitions: numberOfTrials,
    };
    // add phase 1 looping procedure to the main timeline
    timeline.push(trial_procedure_phase4_loop);

    //////// PHASE 5 ////////
    // The probability will now be reversed but the condition stays same
    function chooseLayout_subsequent_Phase5 (matchType) {
        console.log('match type: ', matchType);
        if (matchType == 'ab') {
            // create an array of all teams
            var teams = [teamA, teamB];
            // pick layout at random so all are equally likely. That is, pick the team that is on the left.
            var layoutSelected = jsPsych.randomization.sampleWithReplacement(teams, 1, [1, 1])[0];
            if (layoutSelected == teamA) {
                trialInfo_teamLeft = teamA;
                trialInfo_teamRight = teamB;
            } else {
                trialInfo_teamLeft = teamB;
                trialInfo_teamRight = teamA
            }
            return [[trialInfo_teamLeft, 0, trialInfo_teamRight]];
        } else {
            // create an array of teams
            var teams = [teamC, teamD];
            // pick layout at random so all are equally likely. Pick the team that will be on the left.
            var layoutSelected = jsPsych.randomization.sampleWithReplacement(teams, 1, [1, 1])[0];
            if (layoutSelected == teamC) {
                trialInfo_teamLeft = teamC; // adding trialInfo_Phase1 so that this can be accessed outside the function
                trialInfo_teamRight = teamD;
            } else {
                trialInfo_teamLeft = teamD;
                trialInfo_teamRight = teamC
            };
            return [[trialInfo_teamLeft, 0, trialInfo_teamRight]];
        }
    }

    // set up A-B trial for use in phase 5 looping trial procedure
    var match_phase5_subsequentAB = {
        type: 'html-keyboard-response',
        stimulus: function() {
            // need to wrap all of this in a function so that it runs on every repetition of the trial
            var curr_layout = chooseLayout_subsequent_Phase5('ab');
            var vsl_layout = jsPsych.plugins['vsl-grid-scene'].generate_stimulus(curr_layout, [logo_size, logo_size]);
            return vsl_layout;
        },
        choices: choices,
        prompt: "Who will win? Press C or N",
        trial_duration: stimulusDuration,
        data: function() {
            return {
                phase: 5,
                trial_element: "match",
                condition: IAPScondition2,
                trialNumber: Phase5_trialnumber,
                teamLeft: trialInfo_teamLeft,
                teamRight: trialInfo_teamRight,
                phase5Winner: phase4LoserAB,
                points_cumulative_excludingThisTrial: jsPsych.data.get().select('pointsTotal').max()
            };
        },
        on_finish: function(data) {
            Phase5_trialnumber += 1;
            currentTrialNumber += 1;
            // choose the winner
            var matchPlayers = [phase4WinnerAB, phase4LoserAB];
            var matchOutcome = jsPsych.randomization.sampleWithReplacement(matchPlayers, 1, [20, 80])[0];
            console.log('trial winner: ', matchOutcome);
            // add match winner to data
            data.match_winner = matchOutcome;

            var selected_team;
            if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c") {
                // if c key was pressed, then the participant chose whichever team was on the left
                selected_team = trialInfo_teamLeft;
            } else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n") {
                // if c key was pressed, then the participant chose whichever team was on the right
                selected_team = trialInfo_teamRight;
            }
            console.log('selected team: ', selected_team);
            // add selected team to data
            data.selected_team = selected_team;

            // compare the winning team with the selected team
            if (selected_team == matchOutcome) {
                console.log('correct selection');
                data.accuracy = true;
                trialInfo.pointsTotal = trialInfo.pointsTotal + 0.10;
                data.pointsTotal = trialInfo.pointsTotal;
                console.log('points: ' + trialInfo.pointsTotal);
            } else {
                console.log('incorrect selection');
                data.accuracy = false;
                trialInfo.pointsTotal = trialInfo.pointsTotal + 0;
                data.pointsTotal = trialInfo.pointsTotal;
                console.log('points: ' + trialInfo.pointsTotal);
            }
        }
    };

    // set up C-D trial for use in phase 5 looping trial procedure
    var match_phase5_subsequentCD = {
        type: 'html-keyboard-response',
        stimulus: function() {
            // need to wrap all of this in a function so that it runs on every repetition of the trial
            var curr_layout = chooseLayout_subsequent_Phase5('cd');
            var vsl_layout = jsPsych.plugins['vsl-grid-scene'].generate_stimulus(curr_layout, [logo_size, logo_size]);
            return vsl_layout;
        },
        choices: choices,
        prompt: "Who will win? Press C or N",
        trial_duration: stimulusDuration,
        data: function() {
            return {
                phase: 5,
                trial_element: "match",
                condition: IAPScondition2,
                trialNumber: Phase5_trialnumber,
                teamLeft: trialInfo_teamLeft,
                teamRight: trialInfo_teamRight,
                phase5Winner: phase4LoserCD,
                points_cumulative_excludingThisTrial: jsPsych.data.get().select('pointsTotal').max()
            };
        },
        on_finish: function(data) {
            Phase5_trialnumber += 1;
            currentTrialNumber += 1;
            // choose the winner
            var matchPlayers = [phase4WinnerCD, phase4LoserCD];
            var matchOutcome = jsPsych.randomization.sampleWithReplacement(matchPlayers, 1, [20, 80])[0];
            console.log('trial winner: ', matchOutcome);
            // add match winner to data
            data.match_winner = matchOutcome;

            var selected_team;
            if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c") {
                // if c key was pressed, then the participant chose whichever team was on the left
                selected_team = trialInfo_teamLeft;
            } else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n") {
                // if n key was pressed, then the participant chose whichever team was on the right
                selected_team = trialInfo_teamRight;
            }
            console.log('selected team: ', selected_team);
            // add selected team to data
            data.selected_team = selected_team;

            // compare the winning team with the selected team
            // phase 4 winner/loser is just used to set the sampling weights so that the winner is selected more often)
            if (selected_team == matchOutcome) {
                console.log('correct selection');
                data.accuracy = true;
                trialInfo.pointsTotal = trialInfo.pointsTotal  + 0.10;
                console.log('points: ' + trialInfo.pointsTotal);
            } else {
                console.log('incorrect selection');
                data.accuracy = false;
                trialInfo.pointsTotal  = trialInfo.pointsTotal  + 0;
                console.log('points: ' + trialInfo.pointsTotal);
            }
        }
    };

    var trial_procedure_phase5_loop = {
        timeline: [fixation, pick_IAPSimage2, match_phase5_subsequentAB, points_tracker_inloop, display_too_slow_message_conditional, display_haveabreak_message_conditional, fixation, pick_IAPSimage2, match_phase5_subsequentCD, points_tracker_inloop],
        repetitions: numberOfTrials,
    };
    // add phase 2 looping procedure to the main timeline
    timeline.push(trial_procedure_phase5_loop);

    //////// PHASE 6 ////////

    function chooseLayout_subsequent_Phase6 (matchType) {
        console.log('match type: ', matchType);
        if (matchType == 'ab') {
            // create an array of all teams
            var teams = [teamA, teamB];
            // pick layout at random so all are equally likely. That is, pick the team that is on the left.
            var layoutSelected = jsPsych.randomization.sampleWithReplacement(teams, 1, [1, 1])[0];
            if (layoutSelected == teamA) {
                trialInfo_teamLeft = teamA;
                trialInfo_teamRight = teamB;
            } else {
                trialInfo_teamLeft = teamB;
                trialInfo_teamRight = teamA
            }
            return [[trialInfo_teamLeft, 0, trialInfo_teamRight]];
        } else {
            // create an array of teams
            var teams = [teamC, teamD];
            // pick layout at random so all are equally likely. Pick the team that will be on the left.
            var layoutSelected = jsPsych.randomization.sampleWithReplacement(teams, 1, [1, 1])[0];
            if (layoutSelected == teamC) {
                trialInfo_teamLeft = teamC; // adding trialInfo_Phase1 so that this can be accessed outside the function
                trialInfo_teamRight = teamD;
            } else {
                trialInfo_teamLeft = teamD;
                trialInfo_teamRight = teamC
            };
            return [[trialInfo_teamLeft, 0, trialInfo_teamRight]];
        }
    }

    // set up A-B trial for use in phase 6 looping trial procedure
    var match_phase6_subsequentAB = {
        type: 'html-keyboard-response',
        stimulus: function() {
            // need to wrap all of this in a function so that it runs on every repetition of the trial
            var curr_layout = chooseLayout_subsequent_Phase6('ab');
            var vsl_layout = jsPsych.plugins['vsl-grid-scene'].generate_stimulus(curr_layout, [logo_size, logo_size]);
            return vsl_layout;
        },
        choices: choices,
        prompt: "Who will win? Press C or N",
        trial_duration: stimulusDuration,
        data: function() {
            return {
                phase: 6,
                trial_element: "match",
                condition: IAPScondition2,
                trialNumber: Phase6_trialnumber,
                teamLeft: trialInfo_teamLeft,
                teamRight: trialInfo_teamRight,
                phase6Winner: phase4WinnerAB,
                points_cumulative_excludingThisTrial: jsPsych.data.get().select('pointsTotal').max()
            };
        },
        on_finish: function(data) {
            Phase6_trialnumber += 1;
            currentTrialNumber += 1;
            // choose the winner
            var matchPlayers = [phase4WinnerAB, phase4LoserAB];
            var matchOutcome = jsPsych.randomization.sampleWithReplacement(matchPlayers, 1, [80, 20])[0];
            console.log('trial winner: ', matchOutcome);
            // add match winner to data
            data.match_winner = matchOutcome;

            var selected_team;
            if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c") {
                // if c key was pressed, then the participant chose whichever team was on the left
                selected_team = trialInfo_teamLeft;
            } else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n") {
                // if c key was pressed, then the participant chose whichever team was on the right
                selected_team = trialInfo_teamRight;
            }
            console.log('selected team: ', selected_team);
            // add selected team to data
            data.selected_team = selected_team;

            // compare the winning team with the selected team
            if (selected_team == matchOutcome) {
                console.log('correct selection');
                data.accuracy = true;
                trialInfo.pointsTotal = trialInfo.pointsTotal + 0.10;
                data.pointsTotal = trialInfo.pointsTotal;
                console.log('points: ' + trialInfo.pointsTotal);
            } else {
                console.log('incorrect selection');
                data.accuracy = false;
                trialInfo.pointsTotal = trialInfo.pointsTotal + 0;
                data.pointsTotal = trialInfo.pointsTotal;
                console.log('points: ' + trialInfo.pointsTotal);
            }
        }
    };

    // set up C-D trial for use in phase 6 looping trial procedure
    var match_phase6_subsequentCD = {
        type: 'html-keyboard-response',
        stimulus: function() {
            // need to wrap all of this in a function so that it runs on every repetition of the trial
            var curr_layout = chooseLayout_subsequent_Phase6('cd');
            var vsl_layout = jsPsych.plugins['vsl-grid-scene'].generate_stimulus(curr_layout, [logo_size, logo_size]);
            return vsl_layout;
        },
        choices: choices,
        prompt: "Who will win? Press C or N",
        trial_duration: stimulusDuration,
        data: function() {
            return {
                phase: 6,
                trial_element: "match",
                condition: IAPScondition2,
                trialNumber: Phase3_trialnumber,
                teamLeft: trialInfo_teamLeft,
                teamRight: trialInfo_teamRight,
                phase6Winner: phase4WinnerCD,
                points_cumulative_excludingThisTrial: jsPsych.data.get().select('pointsTotal').max()
            };
        },
        on_finish: function(data) {
            Phase6_trialnumber += 1;
            currentTrialNumber += 1;
            // choose the winner
            var matchPlayers = [phase4WinnerCD, phase4LoserCD];
            var matchOutcome = jsPsych.randomization.sampleWithReplacement(matchPlayers, 1, [80, 20])[0];
            console.log('trial winner: ', matchOutcome);
            // add match winner to data
            data.match_winner = matchOutcome;

            var selected_team;
            if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "c") {
                // if c key was pressed, then the participant chose whichever team was on the left
                selected_team = trialInfo_teamLeft;
            } else if (jsPsych.pluginAPI.convertKeyCodeToKeyCharacter(data.key_press) == "n") {
                // if n key was pressed, then the participant chose whichever team was on the right
                selected_team = trialInfo_teamRight;
            }
            console.log('selected team: ', selected_team);
            // add selected team to data
            data.selected_team = selected_team;

            // compare the winning team with the selected team
            // phase 1 winner/loser is just used to set the sampling weights so that the winner is selected more often)
            if (selected_team == matchOutcome) {
                console.log('correct selection');
                data.accuracy = true;
                trialInfo.pointsTotal = trialInfo.pointsTotal  + 0.10;
                console.log('points: ' + trialInfo.pointsTotal);
            } else {
                console.log('incorrect selection');
                data.accuracy = false;
                trialInfo.pointsTotal  = trialInfo.pointsTotal  + 0;
                console.log('points: ' + trialInfo.pointsTotal);
            }
        }
    };

    var trial_procedure_phase6_loop = {
        timeline: [fixation, pick_IAPSimage2, match_phase6_subsequentAB, points_tracker_inloop, display_too_slow_message_conditional, display_haveabreak_message_conditional, fixation, pick_IAPSimage2, match_phase6_subsequentCD, points_tracker_inloop],
        repetitions: numberOfTrials,
    };
    // add phase 6 looping procedure to the main timeline
    timeline.push(trial_procedure_phase6_loop);

    // add end message and show how much money participant "won"
    var endMessage = {
        type: 'html-keyboard-response',
        stimulus: function () {
            var finalScore_raw = jsPsych.data.get().select('pointsTotal').max();
            var finalScore = (Math.round(finalScore_raw * 100)/100).toFixed(2);
            var message = '<h1>&#x1F389 <br>Congratulations!</h1> <p>You&#39;ve finished with this game. <br><br>If it was real money, <br>you would&#39;ve won <b>£' + finalScore + '</b>!</p>';
            return message;
        },
        prompt: "<h2>Press space to continue</h2>"
    };
    timeline.push(endMessage)

    jatos.onLoad(function() {

      jsPsych.data.addProperties({
        jatos_study_ID: jatos.studyId,
        jatos_component_ID: jatos.componentId,
        jatos_component_result_ID: jatos.componentResultId,
        jatos_worker_ID: jatos.workerId,
        jatos_study_result_ID: jatos.studyResultId,
      });


      jsPsych.init({
          timeline: timeline,
          show_progress_bar: false,
          preload_images: [photoDatabase_neu_trial, photoDatabase_neg_trial, logo1, logo2, logo3, logo4], // preload images so that the experiment runs well
          show_preload_progress_bar: true, //hide preload progress bar
          on_finish: function() {
              // jsPsych.data.displayData();
              var result_json = jsPsych.data.get().json() + jsPsych.data.getInteractionData().json(); // This added on part after the + is to send browser interactions to JATOS in addition to trial data
              jatos.submitResultData(result_json, jatos.startNextComponent);
          }
      });
    });

</script>
</html>
